rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // 歌曲集合 - 所有人可讀，僅管理員可寫
    match /songs/{songId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // 投票集合 - 所有人可讀取，新增需驗證，僅管理員可刪除
    match /votes/{voteId} {
      allow read: if true;
      // 投票限制：需有有效資料，且限制建議內容長度
      allow create: if isValidVote();
      allow delete: if isAdmin();
    }
    
    // 歌曲建議集合 - 所有人可讀取，新增需驗證內容，僅管理員可更新狀態
    match /songSuggestions/{suggestionId} {
      allow read: if true;
      // 建議內容過濾：限制標題、歌手、備註長度
      allow create: if isValidSuggestion();
      allow update, delete: if isAdmin();
    }
    
    // 標籤集合 - 所有人可讀，僅管理員可寫
    match /tags/{tagId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // 歌曲標籤關聯集合 - 所有人可讀，僅管理員可寫
    match /songTags/{songTagId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // 彈奏狀態集合 - 所有人可讀（即時同步），僅管理員可寫
    match /playedSongs/{playedId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // 正在彈奏狀態集合 - 所有人可讀（即時同步），僅管理員可寫
    match /nowPlaying/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // QR Code 掃描記錄 - 所有人可讀寫（用於統計）
    match /qrCodeScans/{scanId} {
      allow read, write: if true;
    }
    
    // 互動集合 - 打賞和評分（所有人可讀取、新增需驗證格式、更新評分需驗證）
    match /interactions/{interactionId} {
      allow read: if true;
      allow create: if isValidInteraction();
      // 允許更新評分（只能更新 rating 和 createdAt，sessionId 不能變）
      allow update: if isValidRatingUpdate();
      allow delete: if isAdmin();
    }
    
    // 使用者集合 - 僅本人或管理員可讀寫
    match /users/{userId} {
      allow read: if request.auth != null && 
        (request.auth.uid == userId || isAdmin());
      allow write: if request.auth != null && 
        (request.auth.uid == userId || isAdmin());
    }
    
    // ==================== 輔助函式 ====================
    
    // 檢查是否為管理員
    function isAdmin() {
      return request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }
    
    // 驗證投票資料有效性
    function isValidVote() {
      let data = request.resource.data;
      return data.keys().hasAll(['songId', 'sessionId', 'createdAt'])
        && data.songId is string
        && data.songId.size() > 0
        && data.songId.size() <= 100
        && data.sessionId is string
        && data.sessionId.size() > 0
        && data.sessionId.size() <= 100;
    }
    
    // 驗證歌曲建議資料有效性
    function isValidSuggestion() {
      let data = request.resource.data;
      return data.keys().hasAll(['title', 'artist', 'status', 'createdAt'])
        // 標題限制：必填，最長 100 字元
        && data.title is string
        && data.title.size() > 0
        && data.title.size() <= 100
        // 歌手限制：必填，最長 50 字元
        && data.artist is string
        && data.artist.size() > 0
        && data.artist.size() <= 50
        // 備註限制：選填，可以是 null 或字串，最長 500 字元
        && (!data.keys().hasAny(['notes']) || data.notes == null || (data.notes is string && data.notes.size() <= 500))
        // 推薦者限制：選填，可以是 null 或字串，最長 50 字元
        && (!data.keys().hasAny(['suggestedBy']) || data.suggestedBy == null || (data.suggestedBy is string && data.suggestedBy.size() <= 50))
        // 狀態必須是 pending
        && data.status == 'pending';
    }
    
    // 驗證互動資料有效性（打賞和評分）
    function isValidInteraction() {
      let data = request.resource.data;
      return data.keys().hasAll(['songId', 'type', 'sessionId', 'createdAt'])
        // songId 限制：必填字串
        && data.songId is string
        && data.songId.size() > 0
        && data.songId.size() <= 100
        // type 限制：必須是 tip 或 rating
        && data.type in ['tip', 'rating']
        // sessionId 限制：必填字串
        && data.sessionId is string
        && data.sessionId.size() > 0
        && data.sessionId.size() <= 100
        // tipType 限制：選填，必須是有效 emoji
        && (!data.keys().hasAny(['tipType']) || data.tipType == null || (data.tipType is string && data.tipType.size() <= 10))
        // rating 限制：選填，必須是 1-5
        && (!data.keys().hasAny(['rating']) || data.rating == null || (data.rating is int && data.rating >= 1 && data.rating <= 5));
    }
    
    // 驗證評分更新（只能更新自己的評分，且只能修改 rating 和 createdAt）
    function isValidRatingUpdate() {
      let data = request.resource.data;
      let existing = resource.data;
      return existing.type == 'rating'
        // sessionId 不能變更
        && data.sessionId == existing.sessionId
        // songId 不能變更
        && data.songId == existing.songId
        // type 不能變更
        && data.type == existing.type
        // rating 必須是 1-5
        && data.rating is int
        && data.rating >= 1
        && data.rating <= 5;
    }
  }
}
